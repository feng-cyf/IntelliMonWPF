<UserControl x:Class="IntelliMonWPF.Views.DeviceManagementUC"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:IntelliMonWPF.Views"
             mc:Ignorable="d" 
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors" xmlns:core="http://prismlibrary.com/" xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             d:DesignHeight="800" d:DesignWidth="1000">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="549*"/>
            <ColumnDefinition Width="451*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <UniformGrid Columns="6" Grid.ColumnSpan="2">
            <!-- 添加设备：主蓝色（新增操作，视觉突出） -->
            <Button Content="添加设备" Command="{Binding AddDeviceCommand}" Margin="10"  
        Background="#165DFF" Foreground="White" 
        BorderBrush="#165DFF" BorderThickness="1"/>

            <Button Content="新增读取" Command="{Binding ShoeAddDeviceCmd}" Margin="10"  
        Background="Gray" Foreground="White" 
        BorderBrush="#165DFF" BorderThickness="1"/>

            <!-- 编辑设备：天蓝色（修改操作，温和区分） -->
            <Button Content="编辑设备" Command="{Binding EditDeviceCmd}" Margin="10"  
        Background="#36CFC9" Foreground="White" 
        BorderBrush="#36CFC9" BorderThickness="1"/>

            <!-- 启动设备：绿色（正向操作，代表运行） -->
            <Button Content="启动设备" Command="{Binding OpenDeviceCmd}" Margin="10"  
        Background="#52C41A" Foreground="White" 
        BorderBrush="#52C41A" BorderThickness="1"/>

            <!-- 停止设备：橙色（警示操作，代表暂停） -->
            <Button Content="停止设备" Margin="10"  
        Background="#FAAD14" Foreground="White" 
        BorderBrush="#FAAD14" BorderThickness="1"
                    Command="{Binding StopDeviceCmd}"/>

            <!-- 删除设备：红色（危险操作，强提醒） -->
            <Button Content="删除设备" Command="{Binding RemoveDeviceCmd}" Margin="10"  
        Background="#FF4D4F" Foreground="White" 
        BorderBrush="#FF4D4F" BorderThickness="1"/>
        </UniformGrid>
        <UniformGrid Columns="3" Grid.Row="1" Grid.ColumnSpan="2">
            <Button Command="{Binding ApiSaveCmd}" Content="导入数据库" Margin="0 5" ToolTip="导入设备名称和从站id到数据库"></Button>
            <Button Content="一键关闭" Command="{Binding StopAllDeviceCmd}"></Button>
            <Button Content="一键打开" Command="{Binding StartDeviceCmd}"></Button>
        </UniformGrid>
        <Grid Grid.Row="2" Grid.ColumnSpan="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>
            <!-- 外层：设备列表 -->
            <DataGrid ItemsSource="{Binding Devices}"
          SelectedItem="{Binding SelectedDevice}"
          AutoGenerateColumns="False"
          Grid.Column="0"
          RowDetailsVisibilityMode="Visible"
          IsReadOnly="True" Margin="0,0,10,0">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="设备名称" Binding="{Binding DeviceName}" Width="150"/>
                    <DataGridTextColumn Header="类型"     Binding="{Binding Type}"       Width="120"/>
                    <DataGridTextColumn Header="类型"     Binding="{Binding Status}"       Width="200"/>
                </DataGrid.Columns>

                <!-- 行展开：当前设备下的所有 ReadModel -->
                <DataGrid.RowDetailsTemplate>
                    <DataTemplate>
                        <DataGrid ItemsSource="{Binding ReadModels}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  SelectedItem="{Binding DataContext.SelectedReadModel, 
                                         RelativeSource={RelativeSource AncestorType=UserControl}, Mode=TwoWay}"
                  SelectionUnit="FullRow"
                  SelectionMode="Single"
                  Margin="20,0,0,0">
                            <i:Interaction.Triggers>
                                <i:EventTrigger EventName="MouseDoubleClick">
                                    <core:InvokeCommandAction
                        Command="{Binding DataContext.RowDoubleClickCommand,
                                          RelativeSource={RelativeSource AncestorType=UserControl}}"
                        CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource Self}}"/>
                                </i:EventTrigger>
                            </i:Interaction.Triggers>
                            <DataGrid.Columns>
                                <!-- 去掉设备名称列 -->
                                <DataGridTextColumn Header="SlaveId"      Binding="{Binding SlaveId}"      Width="80"/>
                                <DataGridTextColumn Header="起始地址"     Binding="{Binding StartAddress}" Width="120"/>
                                <DataGridTextColumn Header="寄存器数"     Binding="{Binding NumAddress}"   Width="120"/>
                                <DataGridTextColumn Header="功能码"       Binding="{Binding Function}"     Width="100"/>
                                <DataGridTextColumn Header="轮询周期"     Binding="{Binding Interavel}"    Width="120"/>
                                <DataGridTextColumn Header="状态"         Binding="{Binding Status}"       Width="300"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </DataTemplate>
                </DataGrid.RowDetailsTemplate>
            </DataGrid>
            <materialDesign:Snackbar
         x:Name="MySnackbar"
         MessageQueue="{Binding messageQueue}"
         VerticalAlignment="Center"
         HorizontalAlignment="Center"
         Margin="10"
         Height="100"
         Width="100"
                Panel.ZIndex="9999"
        Grid.Row="1"
         Background="Black"
         Foreground="White"/>
            <ScrollViewer Grid.Column="1"
                  VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled"
                  MaxHeight="800"
                  VerticalAlignment="Stretch"
                  HorizontalAlignment="Stretch">
                <Border Background="White"
                CornerRadius="5"
                BorderBrush="#DDDDDD"
                BorderThickness="1"
                Margin="0,0,0,28">
                    <StackPanel Margin="15">
                        <TextBlock Text="设备筛选" FontSize="16" FontWeight="Bold" Margin="0,0,0,15"/>
                        <Expander Header="筛选条件" IsExpanded="True" Margin="0,0,0,10">
                            <Grid Margin="10 5 0 5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="设备名称:" Grid.Row="0" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding DeviceName, UpdateSourceTrigger=PropertyChanged}" Grid.Row="0" Grid.Column="1" Margin="5,0,0,0"/>
                                <TextBlock Text="设备功能码:" Grid.Row="1" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding DeviceCon, UpdateSourceTrigger=PropertyChanged}" Grid.Row="1" Grid.Column="1" Margin="5,0,0,0"/>
                                <TextBlock Text="设备运行状态:" Grid.Row="2" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding DeviceStatus, UpdateSourceTrigger=PropertyChanged}" Grid.Row="2" Grid.Column="1" Margin="5,0,0,0"/>
                                <Button Content="筛选查找" Command="{Binding SearchDeviceCmd}" Grid.Row="3" Grid.ColumnSpan="2" Margin="0,10,0,0" 
                                    Background="#165DFF" Foreground="White" 
                                    BorderBrush="#165DFF" BorderThickness="1"/>
                            </Grid>
                        </Expander>
                        <TextBlock Text="设备详情" FontSize="16" FontWeight="Bold" Margin="0,0,0,15"/>

                        <!-- 基本信息 -->

                        <Expander Header="基本信息" IsExpanded="True" Margin="0,0,0,10">
                            <Grid Margin="10,5,0,5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Text="设备名称:" Grid.Row="0"/>
                                <TextBlock Text="{Binding SelectedDevice.DeviceName}" Grid.Row="0" Grid.Column="1"/>

                                <TextBlock Text="设备类型:" Grid.Row="1" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedDevice.Type}" Grid.Row="1" Grid.Column="1" Margin="0,5,0,0"/>
                            </Grid>
                        </Expander>

                        <!-- 通信参数 -->
                        <Expander Header="通信参数" IsExpanded="True" Margin="0,0,0,10">
                            <Grid Margin="10,5,0,5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Text="读取数量:" Grid.Row="0"/>
                                <TextBlock Text="{Binding SelectedReadModel.NumAddress}" Grid.Row="0" Grid.Column="1"/>

                                <TextBlock Text="读取地址:" Grid.Row="1" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedReadModel.StartAddress}" Grid.Row="1" Grid.Column="1" Margin="0,5,0,0"/>

                                <TextBlock Text="从站ID:" Grid.Row="2" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedReadModel.SlaveId}" Grid.Row="2" Grid.Column="1" Margin="0,5,0,0"/>

                                <TextBlock Text="最大错误次数:" Grid.Row="3" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedReadModel.MaxError}" Grid.Row="3" Grid.Column="1" Margin="0,5,0,0"/>
                                <TextBlock Text="设备自行故障:" Grid.Row="4" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedDevice.IsAutoCon}" Grid.Row="4" Grid.Column="1" Margin="0,5,0,0"/>
                            </Grid>
                        </Expander>

                        <!-- 运行参数 -->
                        <Expander Header="运行参数" IsExpanded="True" Margin="0,0,0,10">
                            <Grid Margin="10,5,0,5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Text="轮询间隔:" Grid.Row="0"/>
                                <TextBlock Text="{Binding SelectedReadModel.Interavel}" Grid.Row="0" Grid.Column="1"/>

                                <TextBlock Text="当前状态:" Grid.Row="1" Margin="0,5,0,0"/>
                                <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Margin="0,5,0,0">
                                    <Ellipse Width="10" Height="10"/>
                                    <TextBlock Text="{Binding SelectedReadModel.Status}" Margin="5,0,0,0"/>
                                </StackPanel>
                            </Grid>
                        </Expander>
                        <Expander Header="其他信息" IsExpanded="True" Margin="0,0,0,10">
                            <Grid Margin="10,5,0,5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="100"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Text="最后通信时间:" Grid.Row="0" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedDevice.Notes}" Grid.Row="1" Grid.Column="1" Margin="0,5,0,0" TextWrapping="Wrap"/>
                                <TextBlock Text="错误计数:" Grid.Row="1" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedReadModel.ErrorCount}" Grid.Row="1" Grid.Column="1" Margin="0,5,0,0" TextWrapping="Wrap"/>
                            </Grid>
                        </Expander>
                        <Button Content="导入csv" Margin="0 10"></Button>
                        <Button Content="报文查看" Margin="0 10" Command="{Binding ShowPackUCCmdCommand}"></Button>

                    </StackPanel>
                </Border>
            </ScrollViewer>
        </Grid>

    </Grid>
</UserControl>
